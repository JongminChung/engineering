# 인터넷 통신

Host A가 Host B와 통신하는 전체적인 플로우를 설명하겠습니다.

1. 호스트 A가 호스트 B의 도메인 이름을 입력 (L7 - 응용 계층)
    - 호스트 A는 웹 브라우저 등에서 호스트 B의 도메인 이름(예: <www.example.com)을> 입력합니다.
    - 이 도메인 이름은 IP 주소로 변환되어야 통신이 가능합니다.

2. DNS 쿼리 (L7 - 응용 계층)
    - 호스트 A는 도메인 이름(<www.example.com)을> IP 주소로 변환하기 위해 DNS 쿼리를 시작합니다.
    - 호스트 A는 로컬 DNS 캐시를 확인합니다. 만약 캐시에 해당 도메인의 IP 주소가 있다면, 바로 사용합니다.
    - 캐시에 없으면, 호스트 A는 설정된 DNS 서버(예: 8.8.8.8)로 DNS 쿼리를 보냅니다.
    - DNS 서버는 도메인 이름을 IP 주소로 변환하여 응답합니다. (예: 93.184.216.34)

3. 호스트 A가 호스트 B의 IP 주소를 확인 (L3 - 네트워크 계층)
    - 호스트 A는 DNS 응답을 통해 호스트 B의 IP 주소(93.184.216.34)를 얻습니다.
    - 호스트 A는 이제 이 IP 주소를 사용하여 통신을 시작합니다.

4. 호스트 A가 호스트 B가 같은 서브넷인지 확인 (L3 - 네트워크 계층)
    - 호스트 A는 자신의 IP 주소와 서브넷 마스크를 사용하여 자신이 속한 네트워크를 계산합니다.
        - 예: 호스트 A의 IP 주소 = 192.168.1.2/24
        - 네트워크 주소 = 192.168.1.0/24

    - 호스트 A는 호스트 B의 IP 주소(93.184.216.34)가 같은 네트워크에 속하는지 확인합니다.
        - 호스트 B의 네트워크 주소 = 93.184.216.0 (서브넷 마스크 255.255.255.0 적용)
        - 결론: 호스트 B는 호스트 A와 같은 서브넷에 있지 않음.

5. 기본 게이트웨이로 패킷 전송 결정 (L3 - 네트워크 계층)
    - 호스트 A는 호스트 B가 같은 서브넷에 있지 않다는 것을 확인하고, 패킷을 기본 게이트웨이로 전송하기로 결정합니다.
    - 기본 게이트웨이의 IP 주소는 일반적으로 라우터의 IP 주소입니다. (예: 192.168.1.1)

6. ARP를 통해 기본 게이트웨이의 MAC 주소 획득 (L2 - 데이터 링크 계층)
    - 호스트 A는 기본 게이트웨이의 IP 주소(192.168.1.1)를 알고 있지만, MAC 주소는 모릅니다.
    - 호스트 A는 ARP 요청을 보내 기본 게이트웨이의 MAC 주소를 획득합니다.
    - ARP 요청: "Who has 192.168.1.1? Tell 192.168.1.2"
    - **기본 게이트웨이(라우터)**는 ARP 요청에 응답하여 자신의 MAC 주소를 호스트 A에게 알려줍니다.

7. 패킷 전송 (L2 - 데이터 링크 계층)
    - 호스트 A는 기본 게이트웨이의 MAC 주소를 알게 되었으므로, 패킷을 전송할 수 있습니다.
    - 호스트 A는 호스트 B의 IP 주소(93.184.216.34)를 목적지로 하는 패킷을 생성하고,
      이 패킷을 기본 게이트웨이의 MAC 주소로 전송합니다.

8. 라우터에서의 라우팅 (L3 - 네트워크 계층)
    - **기본 게이트웨이**(라우터)는 패킷을 받아서 목적지 IP 주소(93.184.216.34)를 확인합니다.
    - 라우터는 자신의 **라우팅 테이블**을 참조하여, 호스트 B가 속한 네트워크로 패킷을 전달할 수 있는지 확인합니다.
        - 라우팅 테이블에 93.184.216.0/24에 대한 경로가 있다면, 해당 경로로 패킷을 전달합니다.
        - 만약 라우팅 테이블에 해당 경로가 없다면, 기본 경로(Default Route)를 사용하여 패킷을 전달합니다.

9. 인터넷 게이트웨이를 통한 전송 (L3 - 네트워크 계층)
    - 만약 호스트 B가 외부 네트워크(인터넷)에 있다면, 라우터는 패킷을 인터넷 게이트웨이로 전송합니다.
    - 인터넷 게이트웨이는 패킷을 외부 네트워크로 전달하기 위해 적절한 라우팅 경로를 선택합니다.

10. 패킷이 인터넷을 통해 전달 (L1 - 물리 계층)
    - 패킷은 인터넷을 통해 목적지 네트워크로 전달됩니다. 이 과정에서 여러 라우터를 거치며,
      각 라우터는 자신의 라우팅 테이블을 참조하여 패킷을 다음 홉으로 전달합니다.
    - 이 단계에서는 물리적인 케이블, 광섬유, 무선 신호 등이 사용됩니다.

11. 목적지 네트워크(**호스트 B가 속한 네트워크**)로의 도착 (L3 - 네트워크 계층)
    - 패킷이 목적지 네트워크(93.184.216.0/24)에 도착하면,
      해당 네트워크의 라우터는 호스트 B의 MAC 주소를 알아내기 위해 ARP 요청을 보냅니다.

12. ARP를 통해 호스트 B의 MAC 주소 획득 (L2 - 데이터 링크 계층)
    - 호스트 B는 ARP 요청에 응답하여 자신의 MAC 주소를 알려줍니다.

13. 패킷을 호스트 B로 전송 (L2 - 데이터 링크 계층)
    - 라우터는 호스트 B의 MAC 주소로 패킷을 전송합니다.

14. 호스트 B가 패킷 수신 및 처리 (L7 - 응용 계층)
    - 호스트 B는 패킷을 받아서 처리합니다. 예를 들어, 웹 서버라면 요청된 웹 페이지를 응답으로 보냅니다.

15. 응답 패킷이 호스트 A로 전송
    - 호스트 B는 응답 패킷을 호스트 A의 IP 주소(192.168.1.2)로 전송합니다.
    - 이 과정은 위의 단계와 동일하게 반대 방향으로 진행됩니다.

## NAT(PAT)를 사용하는 경우

호스트 A가 사설 IP 주소(192.168.1.2/24)를 사용하고 있고, 인터넷에 접속하기 위해 NAT(PAT)를 사용,
호스트 B(192.168.2.2/24) 또한 NAT(PAT)를 사용하는 경우를 설명하겠습니다.

1. 호스트 A가 호스트 B의 도메인 이름을 입력 (L7 - 응용 계층)
    - 호스트 A는 웹 브라우저 등에서 호스트 B의 도메인 이름(예: <www.example.com)을> 입력합니다.
    - 이 도메인 이름은 IP 주소로 변환되어야 통신이 가능합니다.

2. DNS 쿼리 (L7 - 응용 계층)
    - 호스트 A는 도메인 이름(<www.example.com)을> IP 주소로 변환하기 위해 DNS 쿼리를 시작합니다.
    - 호스트 A는 로컬 DNS 캐시를 확인합니다. 만약 캐시에 해당 도메인의 IP 주소가 있다면, 바로 사용합니다.
    - 캐시에 없으면, 호스트 A는 설정된 DNS 서버(예: 8.8.8.8)로 DNS 쿼리를 보냅니다.
    - DNS 서버는 도메인 이름을 IP 주소로 변환하여 응답합니다. (예: 93.184.216.34)

3. 호스트 A가 호스트 B의 IP 주소를 확인 (L3 - 네트워크 계층)
    - 호스트 A는 DNS 응답을 통해 호스트 B의 IP 주소(93.184.216.34)를 얻습니다.
    - 호스트 A는 이제 이 IP 주소를 사용하여 통신을 시작합니다.

4. 호스트 A가 호스트 B가 같은 서브넷인지 확인 (L3 - 네트워크 계층)
    - 호스트 A는 자신의 IP 주소와 서브넷 마스크를 사용하여 자신이 속한 네트워크를 계산합니다.
        - 예: 호스트 A의 IP 주소 = 192.168.1.2/24
        - 네트워크 주소 = 192.168.1.0/24

    - 호스트 A는 호스트 B의 IP 주소(93.184.216.34)가 같은 네트워크에 속하는지 확인합니다.
        - 호스트 B의 네트워크 주소 = 93.184.216.0 (서브넷 마스크 255.255.255.0 적용)
        - 결론: 호스트 B는 호스트 A와 같은 서브넷에 있지 않음.

5. 기본 게이트웨이로 패킷 전송 결정 (L3 - 네트워크 계층)
    - 호스트 A는 호스트 B가 같은 서브넷에 있지 않다는 것을 확인하고, 패킷을 기본 게이트웨이로 전송하기로 결정합니다.
    - 기본 게이트웨이의 IP 주소는 일반적으로 라우터의 IP 주소입니다. (예: 192.168.1.1)

6. ARP를 통해 기본 게이트웨이의 MAC 주소 획득 (L2 - 데이터 링크 계층)
    - 호스트 A는 기본 게이트웨이의 IP 주소(192.168.1.1)를 알고 있지만, MAC 주소는 모릅니다.
    - 호스트 A는 ARP 요청을 보내 기본 게이트웨이의 MAC 주소를 획득합니다.
    - ARP 요청: "Who has 192.168.1.1? Tell 192.168.1.2"
    - **기본 게이트웨이(라우터)**는 ARP 요청에 응답하여 자신의 MAC 주소를 호스트 A에게 알려줍니다.

7. 패킷 전송 (L2 - 데이터 링크 계층)
    - 호스트 A는 기본 게이트웨이의 MAC 주소를 알게 되었으므로, 패킷을 전송할 수 있습니다.
    - 호스트 A는 호스트 B의 IP 주소(93.184.216.34)를 목적지로 하는 패킷을 생성하고,
      이 패킷을 기본 게이트웨이의 MAC 주소로 전송합니다.

8. 라우터에서의 라우팅 (L3 - 네트워크 계층)
    - **기본 게이트웨이**(라우터)는 패킷을 받아서 목적지 IP 주소(93.184.216.34)를 확인합니다.
    - 라우터는 자신의 **라우팅 테이블**을 참조하여, 호스트 B가 속한 네트워크로 패킷을 전달할 수 있는지 확인합니다.
        - 라우팅 테이블에 93.184.216.0/24에 대한 경로가 있다면, 해당 경로로 패킷을 전달합니다.
        - 만약 라우팅 테이블에 해당 경로가 없다면, 기본 경로(Default Route)를 사용하여 패킷을 전달합니다.

9. NAT 변환 (L3 - 네트워크 계층)
    - **NAT 게이트웨이\***(라우터)는 패킷을 받아서 NAT 변환을 수행합니다.
    - 호스트 A의 사설 IP 주소(192.168.1.2)를 공인 IP 주소(예: 203.0.113.1)로 변환합니다.
    - 변환된 패킷을 외부 네트워크로 전송합니다.

10. 인터넷 게이트웨이를 통한 전송 (L3 - 네트워크 계층)
    - 만약 호스트 B가 외부 네트워크(인터넷)에 있다면, 라우터는 패킷을 인터넷 게이트웨이로 전송합니다.
    - 인터넷 게이트웨이는 패킷을 외부 네트워크로 전달하기 위해 적절한 라우팅 경로를 선택합니다.

11. 패킷이 인터넷을 통해 전달 (L1 - 물리 계층)
    - 패킷은 인터넷을 통해 목적지 네트워크로 전달됩니다. 이 과정에서 여러 라우터를 거치며,
      각 라우터는 자신의 라우팅 테이블을 참조하여 패킷을 다음 홉으로 전달합니다.
    - 이 단계에서는 물리적인 케이블, 광섬유, 무선 신호 등이 사용됩니다.

12. 목적지 네트워크(**호스트 B가 속한 네트워크**)로의 도착 (L3 - 네트워크 계층)
    - 패킷이 목적지 네트워크(93.184.216.0/24)에 도착하면,
      해당 네트워크의 라우터는 호스트 B의 MAC 주소를 알아내기 위해 ARP 요청을 보냅니다.

13. ARP를 통해 호스트 B의 MAC 주소 획득 (L2 - 데이터 링크 계층)
    - 호스트 B는 ARP 요청에 응답하여 자신의 MAC 주소를 알려줍니다.

14. NAT 변환 (L3 - 네트워크 계층)
    - 호스트 B의 라우터는 패킷을 받아서 NAT 변환을 수행합니다.
    - 호스트 B의 공인 IP 주소(93.184.216.34)를 사설 IP 주소(예: 192.168.2.2)로 변환합니다.
    - 변환된 패킷을 호스트 B에게 전달합니다.

15. 패킷을 호스트 B로 전송 (L2 - 데이터 링크 계층)
    - 라우터는 호스트 B의 MAC 주소로 패킷을 전송합니다.

16. 호스트 B가 패킷 수신 및 처리 (L7 - 응용 계층)
    - 호스트 B는 패킷을 받아서 처리합니다. 예를 들어, 웹 서버라면 요청된 웹 페이지를 응답으로 보냅니다.

17. 응답 패킷이 호스트 A로 전송
    - 호스트 B는 응답 패킷을 호스트 A의 IP 주소(192.168.1.2)로 전송합니다.
    - 이 과정은 위의 단계와 동일하게 반대 방향으로 진행됩니다.
